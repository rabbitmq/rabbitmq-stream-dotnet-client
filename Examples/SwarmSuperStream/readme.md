# Super Streams

This demo shows multiple consumers running, with a producer sending messages for a number of different "customers".

The messages for each customer will be processed in order on the same host. If a host goes down, or the number of consumers is increased, the host processing the messages for a consumer will change.

By default there are 30 stream partitions configured, 10 customer numbers, and 2 consumers.

Each consumer writes the messages it receives to a single analytics API service that then shows what consumers have handled what.

The log output of the analytics service shows for each customer, what hosts have handled its messages, and the last 10 messages handled by the host.

## Example Output

This is running with 30 stream partitions, 10 customers, and 2 consumers. No changes to the number of consumers was made during the run.

The output shows that the messages for each customer were processed in order by the same host, and each hosts handled a subset of total number of customers.   

The message numbers are generated by the producer, and can be thought of a global producer messageId - per producer. In brackets are the time the consumer received the message.

The 10 most recent messages are shown for each customer.

```
| info: SuperStreamClients.Analytics.AnalyticsBackgroundWorker[0]
|  Customer: 0
|  Sources: SwarmSuperStream-5,
|  Host (First message received at 13:52:39): 622c9a2d0a10
|  Messages (181): ...1728(14:08:42), 1755(14:08:55), 1766(14:09:02), 1767(14:09:02), 1780(14:09:08), 1782(14:09:10), 1783(14:09:10), 1797(14:09:17), 1799(14:09:18), 1800(14:09:19),
-   |
|  Customer: 1
|  Sources: SwarmSuperStream-8,
|  Host (First message received at 13:52:44): baaf3c4d0426
|  Messages (164): ...1671(14:08:10), 1707(14:08:30), 1716(14:08:35), 1727(14:08:41), 1741(14:08:49), 1743(14:08:50), 1779(14:09:08), 1786(14:09:11), 1791(14:09:15), 1803(14:09:21),
-   |
|  Customer: 2
|  Sources: SwarmSuperStream-13,
|  Host (First message received at 13:52:40): 622c9a2d0a10
|  Messages (199): ...1701(14:08:27), 1706(14:08:30), 1722(14:08:38), 1737(14:08:46), 1745(14:08:51), 1748(14:08:52), 1756(14:08:55), 1770(14:09:03), 1772(14:09:04), 1804(14:09:21),
-   |
|  Customer: 3
|  Sources: SwarmSuperStream-4,
|  Host (First message received at 13:52:46): baaf3c4d0426
|  Messages (174): ...1698(14:08:25), 1699(14:08:25), 1714(14:08:34), 1720(14:08:37), 1750(14:08:52), 1757(14:08:56), 1778(14:09:07), 1784(14:09:10), 1796(14:09:17), 1805(14:09:22),
-   |
|  Customer: 4
|  Sources: SwarmSuperStream-17,
|  Host (First message received at 13:52:49): baaf3c4d0426
|  Messages (169): ...1692(14:08:22), 1713(14:08:33), 1724(14:08:39), 1734(14:08:45), 1739(14:08:48), 1740(14:08:49), 1765(14:09:01), 1775(14:09:05), 1792(14:09:15), 1802(14:09:20),
-   |
|  Customer: 5
|  Sources: SwarmSuperStream-11,
|  Host (First message received at 13:52:36): baaf3c4d0426
|  Messages (196): ...1754(14:08:54), 1759(14:08:57), 1762(14:08:59), 1763(14:08:59), 1764(14:09:00), 1768(14:09:02), 1777(14:09:06), 1788(14:09:13), 1790(14:09:14), 1793(14:09:15),
-   |
|  Customer: 6
|  Sources: SwarmSuperStream-3,
|  Host (First message received at 13:52:37): 622c9a2d0a10
|  Messages (171): ...1703(14:08:28), 1705(14:08:29), 1715(14:08:34), 1730(14:08:43), 1738(14:08:47), 1742(14:08:50), 1747(14:08:51), 1774(14:09:04), 1787(14:09:12), 1794(14:09:15),
-   |
|  Customer: 7
|  Sources: SwarmSuperStream-22,
|  Host (First message received at 13:52:39): baaf3c4d0426
|  Messages (155): ...1710(14:08:32), 1718(14:08:36), 1733(14:08:44), 1746(14:08:51), 1751(14:08:53), 1753(14:08:54), 1760(14:08:58), 1776(14:09:05), 1795(14:09:16), 1806(14:09:22),
-   |
|  Customer: 8
|  Sources: SwarmSuperStream-20,
|  Host (First message received at 13:52:40): baaf3c4d0426
|  Messages (209): ...1731(14:08:43), 1736(14:08:46), 1749(14:08:52), 1769(14:09:03), 1771(14:09:04), 1773(14:09:04), 1781(14:09:09), 1785(14:09:11), 1789(14:09:14), 1801(14:09:19),
-   |
|  Customer: 9
|  Sources: SwarmSuperStream-26,
|  Host (First message received at 13:52:45): baaf3c4d0426
|  Messages (190): ...1660(14:08:04), 1669(14:08:09), 1674(14:08:12), 1717(14:08:36), 1732(14:08:44), 1752(14:08:53), 1758(14:08:56), 1761(14:08:59), 1798(14:09:18), 1807(14:09:23),
-   |
-   |
```

## Configuration

The defaults for the configuration can be seen in RabbitMqStreamOptions.cs

```
public class RabbitMqStreamOptions
{
    public static string Name = "SwarmSuperStreams";
    public string HostName { get; set; } = "rabbitmq";
    public string UserName { get; set; } = "guest";
    public string Password { get; set; } = "guest";
    public string VirtualHost { get; set; } = "/";
    public int StreamPort { get; set; } = 5552;
    public string StreamName { get; set; } = "SwarmSuperStream";
    public int RandomSeed { get; set; } = 5432;
    public int ProducerMessageSendLimit { get; set; } = int.MaxValue;
    public int NumberOfCustomers { get; set; } = 100;
    public int ProducerSendDelayMin { get; set; } = 100;
    public int ProducerSendDelayMax { get; set; } = 1000;
    public string ConsumerAppReference { get; set; } = "SwarmSuperStreamApp";
    public int ConsumerHandleDelayMin { get; set; } = 100;
    public int ConsumerHandleDelayMax { get; set; } = 1000;
    public int MaxMessagesToShowInAnalytics {get;set;} = 10;
    public bool Consumer {get;set;} = true;
    public bool Producer {get;set;} = true;
    public bool Analytics {get;set;} = true;
    public string AnalyticsApi{get;set;}="http://localhost:5070";
}
```

These can be set from Environment Variables, appsettings.json, or inline code.

From docker compose environment variables
```
  producer:
    image: swarmsuperstreamclient
    depends_on:
      - rabbitmq
    environment:
      - SwarmSuperStreams__Consumer=false
      - SwarmSuperStreams__Producer=true
      - SwarmSuperStreams__Analytics=false   
      - SwarmSuperStreams__NumberOfCustomers=10
      - Logging__LogLevel__Default=Information
      - DOTNET_ENVIRONMENT=Production
    deploy:
```

App Settings
```
{
  "SwarmSuperStreams": {
    "StreamName": "SwarmSuperStream",
    "NumberOfCustomers": 10,
    "HostName": "localhost"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Warning",
      "Microsoft.AspNetCore": "Warning",
      "SuperStreamClients": "Warning",
      "SuperStreamClients.Analytics": "Information"
    }
  }
}
```

Inline code
```
builder.Services.AddSwarmSuperStream(
    builder.Configuration.GetSection(RabbitMqStreamOptions.Name),
    options =>
    {
        options.ConsumerHandleDelayMin = 100;
    });
```

[TODO]

### Example Config Chamges

#### Change Number of Customers

[TODO]

## Features to add
- Web GUI for showing stats / analytics


## Run In Swarm
This demo uses docker swarm to show scaling of consumers up and down.

### Pre Reqs

Have docker swarm running 

```
docker swarm init
```

### Run
Set permissions and run

```
sudo chmod +x ./run.sh
./run.sh
````

> If running the run.sh again and there is an error creating the stack. Wait a few seconds and then re run the run.sh command, as it may be taking a while to remove the stack before it is recreated.

### Configuring 
Scale the number of consumers up with:

```
docker service scale superstack_consumer=5
```

Or down to 1 with:

```
docker service scale superstack_consumer=1
```



### View logs
By default, the analytics service logs are shown after the service is running (it will take a little while for rabbitmq to come online before the first output is shown). 

Logs for producer and consumer can be viewed through another terminal.

```
docker service logs superstack_consumer -f
docker service logs superstack_producer -f
```

### Issues



## Run Locally

The demo can also run in a single app with a local rabbitmq instance. Configuration allow turning consumer/producer/analytics on or off.

Build Pre Configured SuperStream Docker Image
```
docker build ./rabbitmq -t swarmsuperstreamrabbitmq
```

Run Rabbit Docker Image
```
docker run \
--name swarmsuperstreamrabbitmq1 \
-p 4369:4369 -p 5671:5671 -p 5672:5672 -p 15671:15671 -p 15672:15672 -p 15691:15691 -p 15692:15692 -p 25672:25672 -p 5552:5552 \
-e RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS="-rabbitmq_stream advertised_host localhost" \
swarmsuperstreamrabbitmq
```

Run App

```
dotnet run --project src/SuperStreamClients 
```
